<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aur–∞Excel</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: "Segoe UI", system-ui, sans-serif; }
    body {
      background: #f9fafb;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .excel-topbar {
      display: flex; gap: 12px; padding: 14px 20px; background: #207145; /* –ó–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç Excel */
      align-items: center;
      border-bottom: 1px solid #1a5a37;
      flex-wrap: wrap;
    }
    .excel-btn {
      padding: 10px 22px; border: none; border-radius: 16px; color: white;
      font-weight: 600; font-size: 16px; cursor: pointer;
      background: linear-gradient(145deg, #2a8f5e, #207145);
      box-shadow: 0 6px 14px rgba(0,0,0,0.2);
      transition: all 0.25s;
    }
    .excel-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      background: linear-gradient(145deg, #30a26d, #258352);
    }

    .excel-toolbar {
      display: flex; align-items: center; padding: 0 20px 0 120px; height: 48px;
      background: #f1f5f9; border-bottom: 1px solid #cbd5e1;
    }
    .cell-address { 
      width: 100px; padding: 0 12px; background: white; border: 1px solid #cbd5e1; 
      text-align: center; font-family: monospace; font-size: 15px;
    }
    .formula-bar {
      flex: 1; padding: 0 14px; background: white; border: 1px solid #cbd5e1;
      outline: none; font-family: monospace; font-size: 16px;
    }
    .header-row {
      display: flex; position: sticky; top: 162px; left: 0; background: #f1f5f9;
      z-index: 10; border-bottom: 1px solid #cbd5e1;
    }
    .col-header {
      width: 90px; height: 28px; display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 600; color: #1e293b;
      border-right: 1px solid #e2e8f0;
    }
    .row-number {
      position: sticky; left: 0; width: 80px; height: 28px;
      display: flex; align-items: center; justify-content: flex-end;
      padding-right: 10px;
      background: #f1f5f9; border-right: 1px solid #e2e8f0;
      font-size: 14px; color: #334155; z-index: 5;
    }
    .excel-grid {
      display: grid; grid-template-columns: repeat(26, 90px); gap: 0;
      padding-left: 80px; background: white;
    }
    .cell {
      width: 90px; height: 28px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
      padding: 3px 6px; outline: none; font-size: 14px; background: white;
      text-align: left;
    }
    .cell:focus {
      background: #dbeafe;
      border: 2px solid #3b82f6;
      z-index: 1;
      padding: 1px 4px;
    }
  </style>
</head>
<body>

<div class="excel-topbar">
  <button class="excel-btn">Œ£ –°—É–º–º–∞</button>
  <button class="excel-btn">‚åÄ –°—Ä–µ–¥–Ω–µ–µ</button>
  <button class="excel-btn">–§–∏–ª—å—Ç—Ä</button>
  <button class="excel-btn">–ì—Ä–∞—Ñ–∏–∫</button>
  <button class="excel-btn">–§–æ—Ä–º–∞—Ç</button>
  <button id="back-to-editor" class="excel-btn">üìÑ –î–æ–∫—É–º–µ–Ω—Ç</button>
</div>

<div class="excel-toolbar">
  <div class="cell-address">A1</div>
  <input class="formula-bar" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ">
</div>

<div class="header-row" id="col-headers"></div>
<div class="excel-grid" id="excel-grid"></div>

<script>
let currentCell = null;

function splitCell(addr) {
  const colMatch = addr.match(/^[A-Z]+/);
  const rowMatch = addr.match(/\d+$/);
  if (!colMatch || !rowMatch) return [0, 0];
  let col = 0;
  for (let i = 0; i < colMatch[0].length; i++) {
    col = col * 26 + (colMatch[0].charCodeAt(i) - 64);
  }
  return [col - 1, parseInt(rowMatch[0]) - 1];
}

function getCellValue(addr) {
  const cell = document.querySelector(`.cell[data-addr="${addr}"]`);
  return cell ? cell.textContent.trim() : '0';
}

function parseFormula(formula) {
  if (!formula.startsWith('=')) return formula;

  try {
    // =SUM(A1:A3)
    if (formula.includes('SUM(')) {
      const range = formula.match(/SUM\(([^)]+)\)/)[1];
      const [start, end] = range.split(':');
      const [startCol, startRow] = splitCell(start);
      const [endCol, endRow] = splitCell(end);
      let sum = 0;
      for (let r = startRow; r <= endRow; r++) {
        for (let c = startCol; c <= endCol; c++) {
          const colLetter = String.fromCharCode(65 + c);
          const val = parseFloat(getCellValue(colLetter + (r + 1))) || 0;
          sum += val;
        }
      }
      return sum;
    }

    // =AVERAGE(B1:B5)
    if (formula.includes('AVERAGE(')) {
      const range = formula.match(/AVERAGE\(([^)]+)\)/)[1];
      const [start, end] = range.split(':');
      const [startCol, startRow] = splitCell(start);
      const [endCol, endRow] = splitCell(end);
      let sum = 0, count = 0;
      for (let r = startRow; r <= endRow; r++) {
        for (let c = startCol; c <= endCol; c++) {
          const colLetter = String.fromCharCode(65 + c);
          const val = parseFloat(getCellValue(colLetter + (r + 1))) || 0;
          sum += val;
          count++;
        }
      }
      return count > 0 ? (sum / count).toFixed(2) : '0';
    }

    // =A1+B1, =A1*2 –∏ —Ç.–¥.
    const expr = formula.slice(1);
    if (/^[A-Z]+\d+[\+\-\*\/][A-Z]+\d+$/.test(expr) || /^[A-Z]+\d+[\+\-\*\/]\d+$/.test(expr)) {
      return new Function('return ' + expr
        .replace(/[A-Z]+\d+/g, match => {
          const val = parseFloat(getCellValue(match)) || 0;
          return val;
        })
      )();
    }

    return formula;
  } catch (e) {
    return '#ERROR';
  }
}

function createExcelGrid() {
  const colHeaders = document.getElementById('col-headers');
  const grid = document.getElementById('excel-grid');
  colHeaders.innerHTML = '';
  grid.innerHTML = '';

  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ A-Z
  for (let i = 0; i < 26; i++) {
    const letter = String.fromCharCode(65 + i);
    const th = document.createElement('div');
    th.className = 'col-header';
    th.textContent = letter;
    colHeaders.appendChild(th);
  }

  // –°—Ç—Ä–æ–∫–∏ 1‚Äì100
  for (let row = 1; row <= 100; row++) {
    const rn = document.createElement('div');
    rn.className = 'row-number';
    rn.textContent = row;
    grid.appendChild(rn);
    for (let col = 0; col < 26; col++) {
      const letter = String.fromCharCode(65 + col);
      const addr = `${letter}${row}`;
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.contentEditable = 'true';
      cell.setAttribute('data-addr', addr);
      cell.addEventListener('focus', () => {
        currentCell = cell;
        document.querySelector('.cell-address').textContent = addr;
        document.querySelector('.formula-bar').value = cell.textContent;
      });
      cell.addEventListener('input', () => {
        if (cell.textContent.startsWith('=')) {
          const result = parseFormula(cell.textContent);
          cell.textContent = result;
          cell.setAttribute('title', result);
        }
      });
      grid.appendChild(cell);
    }
  }
}

document.getElementById('back-to-editor').onclick = () => {
  window.location.href = '/aurasystem/editor/';
};

createExcelGrid();
</script>
</body>
</html>

